<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纸怨——天台</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        /* 震动动画 */
        @keyframes strongShake {
            0% { transform: translateX(0) translateY(0); }
            10% { transform: translateX(-5px) translateY(-5px); }
            20% { transform: translateX(5px) translateY(5px); }
            30% { transform: translateX(-5px) translateY(-5px); }
            40% { transform: translateX(5px) translateY(5px); }
            50% { transform: translateX(-5px) translateY(-5px); }
            60% { transform: translateX(5px) translateY(5px); }
            70% { transform: translateX(-5px) translateY(-5px); }
            80% { transform: translateX(5px) translateY(5px); }
            90% { transform: translateX(-3px) translateY(3px); }
            100% { transform: translateX(0) translateY(0); }
        }
        
        .scene.shaking {
            animation: strongShake 0.5s ease-in-out;
        }   
    </style>
</head>
<body>
    <div class="game-container">
        <a href="map.html" class="map-link">回到地图</a>
        
        <div class="scene-area scene-container">
            <!-- 场景1：走廊 -->
            <div class="scene" id="scene1">
                <div class="scene-content">
                    <img src="res/走廊.jpg" alt="教学楼走廊" class="scene-bg">
                    <a href="#scene2" class="scene-link" onclick="switchToScene2()"></a>
                    
                    <!-- 物品栏 -->
                    <div class="inventory-area" id="inventory-area">
                        <div class="inventory-placeholder">物品栏</div>
                    </div>
                    
                    <!-- 对话容器 -->
                    <div class="dialogue-container" id="dialogue-container">
                        <!-- 初始旁白 -->
                        <div class="narration-box" id="narration-box">
                            <div class="dialog-title">
                                <span style="display:inline-block;width:20px;height:20px;background-color:#4ecdc4;border-radius:50%;text-align:center;line-height:20px;"></span>
                                旁白
                            </div>
                            <div class="narration-text" id="narration-content">
                                教学楼矗立在夜色里，像一具被遗忘的巨兽骸骨。墙皮大片剥落，露出底下黢黑的水泥。空洞的窗框内，几缕破布无风自动——那便是先前疑似的"鬼影"。仅有的光来自二楼我们旧教室的方向，几盏残灯苟延残喘，光线昏黄粘稠，反而衬得黑暗更深。<br><br>推开门，一股混合着霉变、尘土与陈腐的气息扑面而来。
								你下意识地掩了掩鼻子，你难得没做好表情管理，心里嫌弃死了这糟糕的环境，白瞎自己穿的这身漂亮裙子。
                            </div>
                            <div class="dialog-options" id="narration-options">
                                <button onclick="startScene1Dialogue()">【继续】</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 场景2：楼梯 -->
            <div class="scene" id="scene2">
                <div class="scene-content">
                    <img src="res/走廊2.jpg" alt="楼梯间" class="scene-bg">
                    <a href="#scene3" class="scene-link" onclick="switchToScene3()"></a>
                    
                    <!-- 物品栏 -->
                    <div class="inventory-area" id="inventory-area2">
                        <div class="inventory-placeholder">物品栏</div>
                    </div>
                    
                    <!-- 场景2对话容器 -->
                    <div class="dialogue-container" id="scene2-dialogue-container"></div>
                </div>
            </div>

            <!-- 场景3：天台 -->
            <div class="scene" id="scene3">
                <div class="scene-content">
                    <img src="res/roof.jpg" alt="天台" class="scene-bg">
                    <a href="#scene4" class="scene-link" onclick="switchToScene4()"></a>
                    
                    <!-- 物品栏 -->
                    <div class="inventory-area" id="inventory-area3">
                        <div class="inventory-placeholder">物品栏</div>
                    </div>
                    
                    <!-- 场景3对话容器 -->
                    <div class="dialogue-container" id="scene3-dialogue-container"></div>
                </div>
            </div>

            <!-- 场景4：天台结局 -->
            <div class="scene" id="scene4">
                <div class="scene-content">
                    <img src="res/roof4.jpg" alt="天台结局" class="scene-bg">
                    
                    <!-- 物品栏 -->
                    <div class="inventory-area" id="inventory-area4">
                        <div class="inventory-placeholder">物品栏</div>
                    </div>
                    
                    <!-- 场景4对话容器 -->
                    <div class="dialogue-container" id="scene4-dialogue-container"></div>
                </div>
            </div>
        </div>
        
        <!-- 直播评论区 -->
        <div class="live-area">
            <div class="live-header">
                <h3 class="live-title">直播间评论区</h3>
                <span class="viewer-count">在线人数: <span id="viewer-count">31245</span></span>
            </div>
            
            <div class="comment-area" id="comment-area">
            </div>
            
            <div class="comment-input">
                <input type="text" placeholder="发送你的评论..." id="comment-input">
            </div>
        </div>
    </div>

    <script>
        // ==================== 游戏状态管理 ====================
        const gameState = {
            currentScene: 1,
            isDialogueActive: false,
            currentDialogueIndex: 0,
            shownDialogueIds: new Set(),
            inventory: [], // 物品栏
            characters: {
                林晚晴: { position: 'right', color: '#4ecdc4' },
                赵健: { position: 'left', color: '#ff6b6b' },
                王鹏: { position: 'left', color: '#95e1d3' },
                孙薇薇: { position: 'left', color: '#f8a5c2' },
                沈默言: { position: 'left', color: '#778beb' }
            }
        };
        
        // ==================== 物品系统 ====================
        const inventoryItems = {
            '纸条': {
                id: 'note',
                name: '纸条',
                image: 'res/纸条.png'
            },
            '二楼钥匙': {
                id: 'key_second_floor',
                name: '二楼钥匙',
                image: 'res/二楼钥匙.png'
            }
        };
        
        // ==================== 震动效果 ====================
        function triggerShakeEffect() {
            const sceneElement = document.getElementById(`scene${gameState.currentScene}`);
            if (sceneElement) {
                sceneElement.classList.add('shaking');
                setTimeout(() => {
                    sceneElement.classList.remove('shaking');
                }, 3000);
            }
        }
        
        // ==================== 物品栏函数 ====================
        function addItemToInventory(itemId) {
            const item = inventoryItems[itemId];
            if (!item) return;
            
            // 检查是否已经拥有该物品
            const existingItem = gameState.inventory.find(i => i.id === item.id);
            if (!existingItem) {
                gameState.inventory.push({
                    ...item,
                    count: 1
                });
                updateInventoryDisplay();
                return true;
            }
            return false;
        }
        
        function updateInventoryDisplay() {
            // 更新所有场景的物品栏
            for (let i = 1; i <= 4; i++) {
                const inventoryArea = document.getElementById(`inventory-area${i}`) || 
                                     (i === 1 ? document.getElementById('inventory-area') : null);
                if (!inventoryArea) continue;
                
                // 清空物品栏（包括标题）
                inventoryArea.innerHTML = '';
                
                // 始终添加标题
                const titleElement = document.createElement('div');
                titleElement.className = 'inventory-placeholder';
                titleElement.textContent = '物品栏';
                inventoryArea.appendChild(titleElement);
                
                // 添加所有物品
                gameState.inventory.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.title = item.name;
                    
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.name;
                    itemDiv.appendChild(img);
                    
                    inventoryArea.appendChild(itemDiv);
                });
            }
        }
        
        // ==================== 弹幕内容 ====================
        const commentsData = {
            走廊初始: [
                { user: '探险爱好者', text: '终于进教学楼了！好刺激！' },
                { user: '胆小但爱看', text: '这走廊好恐怖啊' },
                { user: '推理大师', text: '破布飘动肯定是风吹的' },
                { user: '恐怖片专家', text: '这种场景必有高能！' }
            ],
            走廊味道: [
                { user: '特殊网友', text: '主播注意安全啊！这地方看着不对劲' },
                { user: '探险家007', text: '这霉菌味隔着屏幕都闻到了' },
                { user: '恐怖爱好者', text: '高能预警！准备捂眼' }
            ],
            楼梯回忆: [
                { user: '记忆大师', text: '赵健当年被罚跑楼梯我记得' },
                { user: '观察员', text: '孙薇薇又在装了' },
                { user: '分析帝', text: '晚晴在回避过去的话题' }
            ],
            圆桌开始: [
                { user: '特殊网友', text: '圆桌会议开始了！' },
                { user: '特殊网友', text: '每个人都要说和小纸的关系' },
                { user: '狼人杀玩家', text: '这是要玩狼人杀啊' }
            ],
            晚晴发言: [
                { user: '网友', text: '晚晴和小纸不熟？真的假的' },
                { user: '网友', text: '主播演技不错啊' }
            ],
            薇薇发言: [
                { user: '网友', text: '孙薇薇又在装纯了' },
                { user: '网友', text: '还抱大腿呢' }
            ],
            赵健发言: [
                { user: '网友', text: '赵健身材不错啊' },
                { user: '网友', text: '体育委员就是壮' }
            ],
            王鹏发言: [
                { user: '侦探迷', text: '王鹏说小纸是他朋友？' },
                { user: '网友', text: '有情况！' },
                { user: '心理分析师', text: '注意每个人的微表情' }
            ],
            对峙王鹏: [
                { user: '网友', text: '王鹏被围攻了！' },
                { user: '网友', text: '他肯定知道什么' },
                { user: '网友', text: '好紧张啊' }
            ],
            沈默言坦白: [
                { user: '特殊网友', text: '卧槽！沈默言在现场？！' },
                { user: '特殊网友', text: '这不是剧本！这是真的！' },
                { user: '吃瓜群众', text: '直播间要炸了！' },
                { user: '网友', text: '快报警啊！' }
            ],
            沈默言赎罪: [
                { user: '网友', text: '为了赎罪？什么意思？' },
                { user: '网友', text: '他做了什么？' },
                { user: '网友', text: '当年到底发生了什么？' }
            ]
        };
        
        // ==================== 场景对话序列 ====================
        const sceneDialogues = {
            // 场景1：走廊对话序列
            scene1: [
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '这什么味儿啊……晚晴姐，我们真要进去吗？感觉这楼随时都会塌。',
                    avatar: 'res/孙薇薇.png',
                    action: '小声抱怨',
                    commentTrigger: '走廊味道'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '来都来了，怕什么？',
                    avatar: 'res/赵健.png',
                    action: '赵健倒是兴致勃勃，他晃了晃手机电筒，刺眼的白光划破黑暗'
                },
                {
                    type: 'narration',
                    content: '王鹏沉默地跟在最后，脚步轻得像猫。<br><br>我下意识掩鼻，继续往前走。<br/><br/><span style="color: #ffcc00;">提示：点击右上角箭头，切换场景</span>'
                }
            ],
            
            // 场景2：楼梯对话
            scene2: [
                {
                    type: 'narration',
                    content: '楼梯间更为压抑。墙面绿漆斑驳脱落，露出暗黄腻子。曾贴满照片与标语的宣传栏，只剩几片残破纸角，在微弱气流中颤抖。台阶积着厚灰，每一步都扬起尘埃，在光柱中浮沉。脚步声、呼吸声在此空洞回响。'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '诶，说起来......这楼梯我当年可跑烂了。每次迟到都被老李罚跑十圈，跑完还得爬回教室。',
                    avatar: 'res/赵健.png'
                },
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '你还说呢，每次打球回来一身汗，坐你旁边我都要被熏死了。还有，你老是不打招呼直接拿我的抽纸，一抽就是半包，自己买不起纸吗？',
                    avatar: 'res/孙薇薇.png'
                },
				{
				    type: 'character',
				    character: '赵健',
				    text: '诶哟，这点小事您还记这么久呢。我薇姐当时大气嘛，回头给您送一箱抽纸去！',
				    avatar: 'res/赵健.png'
				},
                {
                    type: 'character',
                    character: '林晚晴',
                    text: '你那时候还挺受欢迎的吧，总有小女生偷偷往你桌肚里塞饮料。',
                    avatar: 'res/林晚晴.png'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '是啊，可惜高中毕业就各奔东西了，那时候多单纯啊。',
                    avatar: 'res/赵健.png'
                },
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '要说当年，晚晴才是焦点吧？',
                    avatar: 'res/孙薇薇.png'
                },
                {
                    type: 'character',
                    character: '林晚晴',
                    text: '陈年旧事，只记得念书了。',
                    avatar: 'res/林晚晴.png',
                    commentTrigger: '楼梯回忆'
                },
                {
                    type: 'narration',
                    content: '王鹏在最后极低地嘟囔了一句，无人听清。<br><br>楼梯尽头，一道铁栅栏门拦住去路，挂锁与校门那把无异。赵健拽了拽，纹丝不动。'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '游戏设计。',
                    avatar: 'res/沈默言.png'
                },
				{
				    type: 'character',
				    character: '赵健',
				    text: '赵健在他后面做了一个虚空打拳的动作，不满道："神神秘秘的，死装男。"<br/><br/><span style="color: #ffcc00;">提示：点击右上角箭头，切换场景</span>',
				    avatar: 'res/赵健.png'
				}
            ],
            
            // 场景3：天台圆桌对话
            scene3: [
                {
                    type: 'narration',
                    content: '铁门被推开，发出刺耳的"嘎吱"声。天台上，粗糙的水泥地缝钻出杂草。中央竟有一张旧木圆桌和几把椅子。清冷月光（或是桌上应急灯过分明亮的光）洒落。<br><br>沈默言在最里侧坐下，指尖相抵。',
                    commentTrigger: '圆桌开始'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '开始吧。七年前，此地有人坠亡，名叫"小纸"。之后灵异频发。我们作为她旧日同窗，今夜来此，查明真相，赢取"惊喜"。',
                    avatar: 'res/沈默言.png'
                },
                {
                    type: 'narration',
                    content: '他目光落向我，做了个"请"的手势。'
                },
                {
                    type: 'character',
                    character: '林晚晴',
                    text: '高三九班的林校花，学习委员。我长得好好，学习好，人缘好，样样都好。与小纸不熟，无甚交集。',
                    avatar: 'res/林晚晴.png',
                    commentTrigger: '晚晴发言'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '鬼魂，或人为？',
                    avatar: 'res/沈默言.png'
                },
                {
                    type: 'character',
                    character: '林晚晴',
                    text: '我猜是人为。谁在捣鬼，自己清楚。',
                    avatar: 'res/林晚晴.png',
                    innerThought: '随即转向镜头，笑容明媚："观众朋友们，关注点赞，助力揭秘，回去抽奖。"'
                },
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '孙薇薇，文艺委员，晚晴最好的朋友。和小纸不熟啦。闹鬼？应该是人装的吧……我都人设不一直都是美丽草包吗。',
                    avatar: 'res/孙薇薇.png',
                    commentTrigger: '薇薇发言'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '赵健，体育委员。家人们，都看到了我硕大的肌肉了吧，有我在，别怕！',
                    avatar: 'res/赵健.png',
                    action: '他甚至单手拎起椅子，引得旁人侧目。',
                    commentTrigger: '赵健发言'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '那跳楼的？没印象。要我说就是太脆弱。闹鬼？肯定是人搞的！我信科学！',
                    avatar: 'res/赵健.png'
                },
                {
                    type: 'character',
                    character: '王鹏',
                    text: '王鹏……普通学生。我、我认识小纸。她是我……朋友。',
                    avatar: 'res/王鹏.png',
                    commentTrigger: '王鹏发言'
                },
                {
                    type: 'character',
                    character: '王鹏',
                    text: '是她回来了！变成鬼回来了！',
                    avatar: 'res/王鹏.png',
                    action: '王鹏越说越激动，声音都大了一个度。'
                },
                {
                    type: 'character',
                    character: '赵健',
                    text: '你是朋友能不知道原因？',
                    avatar: 'res/赵健.png'
                },
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '是真的朋友吗？',
                    avatar: 'res/孙薇薇.png',
                    innerThought: '语气天真而锐利'
                },
                {
                    type: 'narration',
                    content:'你也看向王鹏，眼里装着怀疑。'
                },
                {
                    type: 'narration',
                    content: '王鹏脸色煞白，蜷缩起来，喃喃重复："她回来了……回来了……"<br><br>你转过头看着沈墨言，却发现他又在直勾勾地看着你。这次你很确信你没看错人，你暗骂神经病，暗恋我吗？一直盯我看，我脸上也没东西吧。<br/><br/><span style="color: #ffcc00;">提示：点击右上角箭头，切换场景</span>'
                }
            ],
            
            // 场景4：天台结局
            scene4: [
                {
                    type: 'narration',
                    content: '沈默言起身，缓步走向天台边缘，手撑矮墙，俯身下望。然后转身，背靠黑暗，脸上绽开一个奇异、近乎陶醉的笑。'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '沈默言，班长。小纸，我也认识。',
                    avatar: 'res/沈默言.png'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '她跳下去时，我就在现场。',
                    avatar: 'res/沈默言.png',
                    commentTrigger: '沈默言坦白'
                },
                {
                    type: 'narration',
                    content: '孙薇薇捂嘴惊叫。<br><br>在众人惊愕目光中，他竟轻盈坐上矮墙边缘，双腿悬空。'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '游戏结束。制造"灵异"的人，是我。',
                    avatar: 'res/沈默言.png'
                },
                {
                    type: 'narration',
                    content: '我心头一紧，迅速瞥向直播间——弹幕已炸。这脱离剧本的展开……我才应该是这场游戏的最终受益人啊!'
                },
                {
                    type: 'character',
                    character: '沈默言',
                    text: '猜猜为什么？"惊喜"暂且保密。但若问缘由……为了赎罪。',
                    avatar: 'res/沈默言.png',
                    innerThought: '他抬头望月，笑容里杂糅苦涩与狂热',
                    commentTrigger: '沈默言赎罪'
                },
				{
				    type: 'character',
				    character: '沈默言',
				    text: '"哈哈…别用那种眼神盯着我。还没完，记得这把钥匙吗？"沈墨言不知从哪掏出的一把钥匙，小巧，黄澄澄的。你立马联系到了走廊上的、大门口的那些挂的锁。"看来你们想到了。"接着他做出一个令在场人更加错愕的举动——沈墨言仰头吞下了这枚钥匙！',
				    avatar: 'res/沈默言.png'
				},
			    {
			        type: 'character',
			        character: '赵健',
			        text: '赵健大喊："你特么疯了吗？你到底要干啥？！"说完做出要去拽沈墨言的动作。',
			        avatar: 'res/赵健.png'
			    },
				{
				    type: 'character',
				    character: '沈默言',
				    text: '现在！校园唯一的出口的钥匙已经被我吞下了，你们出不去了，哈哈哈……你们真应该照照镜子看看你们脸上精彩纷呈的表情。想要出去？那就继续这场游戏！你们的目标就是解开我们的最终谜题——小纸为什么跳楼。而作为奖励，钥匙会在解开最终谜题的时候给你们，不要想着翻墙逃跑和暴力拆解，所有围墙和门已经被我布上了电击装置。怎么样，这下够不够刺激？好玩？有趣？',
				    avatar: 'res/沈默言.png'
				},
				{
					type: 'character',
					character: '赵健',
				    text: '赵健彻底被激怒了，你们也坐不下去了。赵健撸起袖子就朝沈墨言冲过去："TNND，谁要跟你玩这破游戏，老子不玩了，快让老子走！"',
					avatar: 'res/赵健.png'
				},
				{
				    type: 'narration',
				    content: '就在赵健即将触碰到沈墨言的衣袖时，他却双臂大张，身体后仰，整个人翻了出去，就这么轻飘飘地坠下去，像纸飞机一样。临走前嘴角还挂着诡异的笑容。"沈墨言！！！！"赵健右手抓了个空。<br/><br/>你迅速扑到天台旁，只听一道沉重的撞击声，你隐隐约约只看到一道人影趴在教学楼底下脏乱的地砖上。',
                    action: function() {
                        triggerShakeEffect();
                    }
				},
				{
				    type: 'character',
				    character: '孙薇薇',
				    text: '他他他、他真跳了？？！',
				    avatar: 'res/孙薇薇.png'
				},
                {
                    type: 'narration',
                    content: '你似乎还看见"他"身体下有什么液体在流动，少时即蔓延至四面八方。赵健怔怔盯着自己的手。'
                },
				{
				    type: 'character',
				    character: '林晚晴',
				    text: '你大吼："不是你推的，是他自己掉下去的！别愣着了，快下去看看！"然后转身就往楼下冲。',
				    avatar: 'res/林晚晴.png'
				},
				{
					type: 'character',
					character: '孙薇薇',
					text: '一阵激烈的脚步声后，孙薇薇跟在后面边跑边骂："这疯子！"',
					avatar: 'res/孙薇薇.png'
				},
				{
				    type: 'narration',
				    content: '你也顾不上美丽，优雅什么的，先见鬼去吧！你只想着别真众目睽睽下闹出人命了啊，你还不想永远离开这一行业。由于跑得太急，你还差点崴了脚。最后，你们四人半分钟连滚带爬冲到了教学楼前。手电光下，一具穿着沈墨言衣服的假人趴在血红的浆液之中。夜风吹过，很冷，卷起地上的枯叶。你们心更冷，你隐隐约约意识到——这不是一场普通的同学聚会，更不是一场普通的游戏。'
				},
                {
                    type: 'narration',
                    content: '你们站在假人尸体旁，手电光在黑暗中交错摇晃，每个人的脸上都蒙着一层不安的阴影。'
                },
				{
					type: 'character',
					character: '孙薇薇',
					text: '孙薇薇的声音带着哭腔："现在怎么办？沈默言到底在搞什么啊？这、这真的是剧本杀吗？"',
					avatar: 'res/孙薇薇.png'
				},
				{
				    type: 'character',
				    character: '林晚晴',
				    text: '你先安抚着孙薇薇："先跟着他的节奏来吧。"',
				    avatar: 'res/林晚晴.png'
				},
                {
                    type: 'narration',
                    content: '赵健蹲下身，用力扯了扯假人身上的衣服，又摸了摸那滩"血"——粘稠的红色颜料在指尖拉丝。'
                },
                {
                    type: 'character',
					character:'赵健',
                    text: '他站起身，啐了一口："装神弄鬼！"<br><br>他抬头看向校门方向，眼神凶狠，"老子不信邪，去大门看看。不就是个破锁吗，踹不开我拆了它！"',
                    avatar: 'res/赵健.png'
				},
                {
                    type: 'narration',
                    content: '他说完就要走，你急忙拉住他："赵健，别冲动！"<br><br>赵健甩开你的手，"我他妈现在就去把门拆了，敢耍我，我倒要让他见识见识我的厉害！"<br><br>你有点无语，这个头脑简单四肢发达的家伙能不能别那么冲动。但是，也罢，让他去看看又何妨，万一沈默言只是虚张声势呢？'
                },
                {
                    type: 'narration',
                    content: '你只好说："那你小心，有情况手机联系。"<br><br>赵健点点头，大步流星朝学校大门方向走去，身影很快没入黑暗。<br><br>你开始给自己找点事做：'
                },
                {
                    type: 'narration',
                    content: '假人附近的飘落着一张纸条，估计是刚刚被赵健扯下来的。'
                },
                {
                    type: 'narration',
                    content: '你捡起来。纸条用着血红色字体，像是用手指写的：游戏开始！<br><br>你还注意到，右下角还有一个可爱的卡通纸飞机图案。',
                    isGettingItem: true,
                    itemToGet: '纸条'
                },
                {
                    type: 'narration',
                    content: '你蹲下身，强忍着恐惧与不适，在假人身上摸索。衣服是沈默言白天穿的那件灰色衬衫，但里面塞的只是旧报纸和海绵。你翻开假人的外套口袋——空的。内侧口袋——也是空的。<br><br>忽然王鹏小声说了句："它手里有东西。"',
                },
                {
                    type: 'narration',
                    content: '假人攥紧的右手，指缝里露出一小截金属反光。你掰开它僵硬的手指——一把黄铜钥匙躺在掌心。',
                    isGettingItem: true, 
                    itemToGet: '二楼钥匙'
                },
                {
                    type: 'character',
                    character: '孙薇薇',
                    text: '孙薇薇惊喜道："是钥匙！"',
                    avatar: 'res/孙薇薇.png'
                },
                {
                    type: 'character',
                    character: '王鹏',
                    text: '不、不是大门钥匙，这个太小了。',
                    avatar: 'res/王鹏.png'
                },
                {
                    type: 'narration',
                    content: '你仔细看，这确实不是大门那种挂锁的钥匙，而是一把小巧的、老式的单齿钥匙，像是开旧式门锁或抽屉用的。钥匙上贴着一小条胶布，上面用钢笔写着："二楼"。'
                },
                {
                    type: 'narration',
                    content: '"看样子我们接下来得去二楼了。"你起身拍拍手对剩下几个人说道，"还记得每一层楼梯与教室走廊都用铁门隔着的吗？只有二楼那里挂上了锁，其他地方都是直接锁死的。"<br><br>孙薇薇："那我们走、走吧……哎晚晚你慢点，等等我啊！"<br/><br/><span style="color: #ffcc00;">提示：获得了两件物品，回到地图开始走廊关卡</span>'
                }
            ]
        };
        
        // ==================== DOM元素引用 ====================
        const elements = {
            narrationBox: document.getElementById('narration-box'),
            narrationContent: document.getElementById('narration-content'),
            narrationOptions: document.getElementById('narration-options'),
            commentArea: document.getElementById('comment-area'),
            viewerCount: document.getElementById('viewer-count')
        };
        
        // ==================== 通用函数 ====================
        function addComments(comments, interval = 500) {
            let index = 0;
            
            const existingComments = Array.from(elements.commentArea.children).map(child => {
                const textDiv = child.querySelector('div:nth-child(2)');
                return textDiv ? textDiv.textContent : '';
            });
            
            function addNextComment() {
                if (index >= comments.length) return;
                
                const comment = comments[index];
                
                if (!existingComments.includes(comment.text)) {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment pop-in';
                    commentDiv.innerHTML = `
                        <div class="comment-user">${comment.user}</div>
                        <div>${comment.text}</div>
                    `;
                    elements.commentArea.appendChild(commentDiv);
                    
                    setTimeout(() => {
                        commentDiv.style.animation = 'popIn 0.5s ease forwards';
                    }, 10);
                    
                    scrollCommentsToBottom();
                    
                    const currentCount = parseInt(elements.viewerCount.textContent);
                    const increment = Math.floor(Math.random() * 10) + 5;
                    elements.viewerCount.textContent = currentCount + increment;
                }
                
                index++;
                
                if (index < comments.length) {
                    setTimeout(addNextComment, interval);
                }
            }
            
            addNextComment();
        }
        
        function scrollCommentsToBottom() {
            if (elements.commentArea) {
                elements.commentArea.scrollTop = elements.commentArea.scrollHeight;
            }
        }
        
        function startScene1Dialogue() {
            gameState.currentScene = 1;
            gameState.currentDialogueIndex = 0;
            
            if (elements.narrationBox) {
                elements.narrationBox.style.opacity = '0';
                setTimeout(() => {
                    elements.narrationBox.style.display = 'none';
                }, 500);
            }
            
            setTimeout(() => {
                playScene1Dialogue();
            }, 600);
        }
        
        // ==================== 场景切换函数 ====================
        function switchToScene2() {
            gameState.currentScene = 2;
            gameState.currentDialogueIndex = 0;
            
            setTimeout(() => {
                startScene2Dialogue();
            }, 500);
        }
        
        function switchToScene3() {
            gameState.currentScene = 3;
            gameState.currentDialogueIndex = 0;
            
            setTimeout(() => {
                startScene3Dialogue();
            }, 500);
        }
        
        function switchToScene4() {
            gameState.currentScene = 4;
            gameState.currentDialogueIndex = 0;
            
            setTimeout(() => {
                startScene4Dialogue();
            }, 500);
        }
        
        // ==================== 场景1对话播放函数 ====================
        function playScene1Dialogue() {
            const container = document.getElementById('dialogue-container');
            if (!container) return;
            
            const dialogues = sceneDialogues.scene1;
            if (gameState.currentDialogueIndex >= dialogues.length) return;
            
            const dialogue = dialogues[gameState.currentDialogueIndex];
            
            const dialogueId = `scene1_${gameState.currentDialogueIndex}`;
            
            if (dialogue.commentTrigger && commentsData[dialogue.commentTrigger] && !gameState.shownDialogueIds.has(dialogueId)) {
                addComments(commentsData[dialogue.commentTrigger], 500);
                gameState.shownDialogueIds.add(dialogueId);
            }
            
            if (dialogue.type === 'narration') {
                showNarrationDialogue(dialogue.content, container, 'scene1', dialogue.isGettingItem, dialogue.itemToGet);
            } else if (dialogue.type === 'character') {
                showCharacterDialogue(dialogue, container, 'scene1');
            }
        }
        
        // ==================== 场景2、3、4对话播放函数 ====================
        function startScene2Dialogue() {
            const container = document.getElementById('scene2-dialogue-container');
            if (!container) return;
            
            container.innerHTML = '';
            playSceneDialogue('scene2', container);
        }
        
        function startScene3Dialogue() {
            const container = document.getElementById('scene3-dialogue-container');
            if (!container) return;
            
            container.innerHTML = '';
            playSceneDialogue('scene3', container);
        }
        
        function startScene4Dialogue() {
            const container = document.getElementById('scene4-dialogue-container');
            if (!container) return;
            
            container.innerHTML = '';
            playSceneDialogue('scene4', container);
        }
        
        function playSceneDialogue(sceneKey, container) {
            const dialogues = sceneDialogues[sceneKey];
            if (!dialogues || gameState.currentDialogueIndex >= dialogues.length) return;
            
            const dialogue = dialogues[gameState.currentDialogueIndex];
            
            const dialogueId = `${sceneKey}_${gameState.currentDialogueIndex}`;
            
            if (dialogue.commentTrigger && commentsData[dialogue.commentTrigger] && !gameState.shownDialogueIds.has(dialogueId)) {
                addComments(commentsData[dialogue.commentTrigger], 500);
                gameState.shownDialogueIds.add(dialogueId);
            }
            
            if (dialogue.type === 'narration') {
                showNarrationDialogue(dialogue.content, container, sceneKey, dialogue.action, dialogue.isGettingItem, dialogue.itemToGet);
            } else if (dialogue.type === 'character') {
                showCharacterDialogue(dialogue, container, sceneKey);
            }
        }
        
        function showNarrationDialogue(content, container, sceneKey, actionCallback, isGettingItem = false, itemToGet = null) {
            const narrationBox = document.createElement('div');
            narrationBox.className = 'narration-box';
            
            let optionsHTML = '';
            
            if (isGettingItem && itemToGet) {
                // 显示获得物品按钮
                optionsHTML = `
                    <button class="item-get-button" onclick="getItem('${itemToGet}', '${sceneKey}')">【获得物品：${itemToGet}】</button>
                `;
            } else {
                // 显示普通继续按钮
                optionsHTML = `<button onclick="nextDialogue('${sceneKey}', ${actionCallback ? 'true' : 'false'})">【继续】</button>`;
            }
            
            narrationBox.innerHTML = `
                <div class="dialog-title">
                    <span style="display:inline-block;width:20px;height:20px;background-color:#4ecdc4;border-radius:50%;text-align:center;line-height:20px;"></span>
                    旁白
                </div>
                <div class="narration-text">${content}</div>
                <div class="dialog-options">
                    ${optionsHTML}
                </div>
            `;
            
            container.innerHTML = '';
            container.appendChild(narrationBox);
            
            setTimeout(() => {
                narrationBox.style.opacity = '1';
                
                // 如果有回调函数，立即执行（比如震动效果）
                if (actionCallback && typeof actionCallback === 'function') {
                    actionCallback();
                }
            }, 10);
        }
        
        function showCharacterDialogue(dialogue, container, sceneKey) {
            const charConfig = gameState.characters[dialogue.character];
            const dialogueBox = document.createElement('div');
            dialogueBox.className = 'character-box';
            
            let textContent = dialogue.text;
            if (dialogue.innerThought) {
                textContent += `<br><br><em style="color: #aaa;">${dialogue.innerThought}</em>`;
            }
            if (dialogue.action) {
                textContent += `<br><br><span style="color: #ffcc00;">${dialogue.action}</span>`;
            }
            
            let innerHTML = '';
            if (charConfig.position === 'right') {
                innerHTML = `
                    <div class="character-content">
                        <div class="dialog-title">
                            <span class="title-icon" style="background-color:${charConfig.color}"></span>
                            <span class="character-name">${dialogue.character}</span>
                        </div>
                        <div class="dialog-text">${textContent}</div>
                        <div class="dialog-options">
                            <button onclick="nextDialogue('${sceneKey}')">【继续】</button>
                        </div>
                    </div>
                    <div class="character-avatar">
                        <img src="${dialogue.avatar}" alt="${dialogue.character}">
                    </div>
                `;
            } else {
                innerHTML = `
                    <div class="character-avatar">
                        <img src="${dialogue.avatar}" alt="${dialogue.character}">
                    </div>
                    <div class="character-content">
                        <div class="dialog-title">
                            <span class="title-icon" style="background-color:${charConfig.color}"></span>
                            <span class="character-name">${dialogue.character}</span>
                        </div>
                        <div class="dialog-text">${textContent}</div>
                        <div class="dialog-options">
                            <button onclick="nextDialogue('${sceneKey}')">【继续】</button>
                        </div>
                    </div>
                `;
            }
            
            dialogueBox.innerHTML = innerHTML;
            container.innerHTML = '';
            container.appendChild(dialogueBox);
            
            setTimeout(() => {
                dialogueBox.style.opacity = '1';
            }, 10);
        }
        
        function getItem(itemId, sceneKey) {
            // 添加物品到物品栏
            const added = addItemToInventory(itemId);
            
            if (added) {
                // 继续下一个对话
                nextDialogue(sceneKey);
            }
        }
        
        function nextDialogue(sceneKey, hasAction = false) {
            gameState.currentDialogueIndex++;
            
            // 如果有动作回调，跳过当前对话继续下一个
            if (hasAction) {
                gameState.currentDialogueIndex++;
            }
            
            if (sceneKey === 'scene1') {
                playScene1Dialogue();
                return;
            }
            
            const containerId = `scene${gameState.currentScene}-dialogue-container`;
            const container = document.getElementById(containerId);
            
            if (container) {
                playSceneDialogue(sceneKey, container);
            }
        }
        
        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化物品栏
            updateInventoryDisplay();
            
            // 显示初始弹幕
            let initialCommentsShown = false;
            setTimeout(() => {
                if (!initialCommentsShown) {
                    addComments(commentsData.走廊初始, 500);
                    initialCommentsShown = true;
                }
            }, 1000);
            
            window.addEventListener('hashchange', function() {
                const sceneNum = parseInt(window.location.hash.replace('#scene', ''));
                if (!isNaN(sceneNum)) {
                    gameState.currentScene = sceneNum;
                    gameState.currentDialogueIndex = 0;
                    
                    gameState.shownDialogueIds.clear();
                    
                    switch(sceneNum) {
                        case 2:
                            setTimeout(() => startScene2Dialogue(), 300);
                            break;
                        case 3:
                            setTimeout(() => startScene3Dialogue(), 300);
                            break;
                        case 4:
                            setTimeout(() => startScene4Dialogue(), 300);
                            break;
                    }
                }
            });
            
            scrollCommentsToBottom();
            
            setTimeout(() => {
                const initialNarration = document.getElementById('narration-box');
                if (initialNarration) {
                    initialNarration.style.opacity = '1';
                }
            }, 100);
        });
    </script>
</body>
</html>